$Id$ -*-text-*-

This directory, ${HOME}/mie, contains many sets of routines to perform
Mie scattering calculations. Many of the files are just kept around
for historical and validation reasons, however. The most important
useful code is a driver for microphysical simulations including Mie
scattering and aerosol physics.
Owing to its origins, this code is called simply "mie". 
"mie" is in continuous development.

"mie" uses the following files:
mie.cc		Main
mie.hh		Program specific header
mie.sh		Simple shell script driver (used for ARESE)
mie_cls.cc	Class definitions
mie_cls.hh	Class declarations
mie_utl.cc	Utility functions

Additionally, "mie" requires 
libnetcdf	netCDF C library (/usr/include, /usr/lib)
libcsm_c++	Climate/Physics C++ library (${HOME}/c++, ${HOME}/include, ${HOME}/lib)
libcsz_c++	Generic C++ library (${HOME}/c++, ${HOME}/include, ${HOME}/lib)
libnco_c++	C++ interface to netCDF C library (${HOME}/nco/src/nco_c++, ${HOME}/include, ${HOME}/lib)
idx_rfr*.nc	Indices of refraction (${HOME}/idx_rfr, ${DATA}/aca/idx_rfr*.nc)
spc*.nc		Solar spectra (${HOME}/slr_spc, ${DATA}/aca/spc*.nc)
                (mie looks for idx_rfr*.nc and spc*.nc files in DATA_RT, if defined)

Other scripts which make use "mie" or files generated by "mie" include:
${HOME}/idl/mie.pro	Graphs selected output fields (e.g., size distribution)
${HOME}/matlab/mie_brd_bnd_cnv.m Matlab script to re-bin mie-output to SNICAR grid
${HOME}/mie/mie.pl	Run mie jobs in batch setting
${HOME}/mie/mie.sh	Batch job shell script to call mie.pl
${HOME}/mie/mie.txt	Default output file name for mie.sh
${HOME}/mie/mie_dst_cam.sh	Convert mie output to CAM aerosol optics format
${HOME}/mie/mie_mca.sh	Batch scripts for running mie to simulate multi-component aerosols
${HOME}/mie/mie_rsn.sh	Batch scripts for running mie to simulate resonances
${HOME}/mie/mie_rsn.sh	Short scripts to test mie resonance behavior
${HOME}/mie/psd.pl	Mie driver for CAM and SNICAR aerosol properties


Other Miscellaneous files:
BoH83: Bohren and Huffman (1983)
HaT74: Hansen & Travis (1974)
MaS99: Markel & Shalaev (1999)
bpb -> source from Bruce Briegleb
csz -> source from Charlie Zender
jgw -> source from Jeff Wong
jtk -> source from Jeff Kiehl
sgw -> source from Steve Warren

mie_csz_batch*	Routines which loop BoH83 over both size and
		wavelength and graph the results

Following script assembles all files required to run mie
Assemble all required source and data files into one directory:

4. Compile statically-linked binary for distribution

g++ -static -o /home/zender/bin/SUNMP/mie \
/home/zender/obj/SUNMP/mie_utl.o /home/zender/obj/SUNMP/mie_cls.o \
/home/zender/obj/SUNMP/mie.o \
/home/zender/obj/SUNMP/getopt_bsd.o \
-L/home/zender/lib/SUNMP -lcsm_c++ -lcsz_c++ -lnco_c++ \
-L/usr/local/lib -lnetcdf \
-lgsl -lgslblas

5. Create executable tarball http://dust.ess.uci.edu/mie/mie.tar.gz
/bin/rm -r ${DATA}/tmp/mie
mkdir -p ${DATA}/tmp/mie
/bin/cp -f \
${MY_BIN_DIR}/mie \
${HOME}/mie/README \
${DATA}/ps/psd.pdf \
${DATA}/aca/spc_Kur95_01wvn.nc \
${DATA}/aca/spc_Kur95_20wvn.nc \
${DATA}/aca/spc_LaN68.nc \
${DATA}/aca/spc_NeL84.nc \
${DATA}/aca/spc_ThD71.nc \
${DATA}/aca/idx_rfr_DKS91.nc \
${DATA}/aca/idx_rfr_NNM98.nc \
${DATA}/aca/idx_rfr_PaW75.nc \
${DATA}/aca/idx_rfr_SAJ93.nc \
${DATA}/aca/idx_rfr_Vol73.nc \
${DATA}/aca/idx_rfr_shettle.nc \
${DATA}/tmp/mie
cd ${DATA}/tmp;tar cvzf ${DATA}/tmp/mie.tar.gz ./mie
scp ${DATA}/tmp/mie.tar.gz dust.ess.uci.edu:/var/www/html/mie

6. Create source tarball http://dust.ess.uci.edu/mie/mie.tar.gz
/bin/rm -r ${DATA}/tmp/c++
mkdir -p ${DATA}/tmp/c++
/bin/cp -f \
${HOME}/c++/*.cc \
${HOME}/c++/*.hh \
${HOME}/c++/getopt*.* \
${HOME}/c++/ChangeLog \
${HOME}/c++/Makefile \
${HOME}/c++/TODO \
${DATA}/tmp/c++
cd ${DATA}/tmp/c++;rm -f ccc.* cls.* complex.* gsl.* i18n.* tst.*
cd ${DATA}/tmp/c++;touch ccc.cc ccc.hh cls.cc cls.hh complex.cc gsl.cc gsl.hh i18n.cc tst.cc

/bin/rm -r ${DATA}/tmp/mie
mkdir -p ${DATA}/tmp/mie
/bin/cp -f \
${HOME}/mie/Makefile \
${HOME}/mie/README \
${HOME}/mie/TODO \
${HOME}/mie/mie*.?? \
${DATA}/ps/psd.pdf \
${DATA}/aca/spc_Kur95_01wvn.nc \
${DATA}/aca/spc_Kur95_20wvn.nc \
${DATA}/aca/spc_LaN68.nc \
${DATA}/aca/spc_NeL84.nc \
${DATA}/aca/spc_ThD71.nc \
${DATA}/aca/idx_rfr_DKS91.nc \
${DATA}/aca/idx_rfr_NNM98.nc \
${DATA}/aca/idx_rfr_PaW75.nc \
${DATA}/aca/idx_rfr_SAJ93.nc \
${DATA}/aca/idx_rfr_Vol73.nc \
${DATA}/aca/idx_rfr_shettle.nc \
${DATA}/tmp/mie
cd ${DATA}/tmp/mie;rm -f 
cd ${DATA}/tmp;tar cvzf ${DATA}/tmp/mie.tar.gz ./mie ./c++
scp ${DATA}/tmp/mie.tar.gz dust.ess.uci.edu:/var/www/html/mie

7. If you have source code, build libcsz_c++.a, libcsm_c++.a, and mie
   Building requires GCC v. 2.96+, libgsl.a, libnetcdf.a, libnco_c++.a
   Default Makefile tries to install files in following pre-existing
   directories: 
   ${MY_BIN_DIR} binaries
   ${MY_OBJ_DIR} objects & depends
   ${MY_INC_DIR} headers
   ${MY_LIB_DIR} libraries

cd ~
scp esmf.ess.uci.edu:/u/zender/bin/sh/pvmgetarch .
chmod a+x pvmgetarch
export PVM_ARCH=`./pvmgetarch`
mkdir -p bin/${PVM_ARCH} bin/sh include lib/${PVM_ARCH} obj/${PVM_ARCH}
mv ~/pvmgetarch ~/bin/sh
export MY_BIN_DIR="${HOME}/bin/${PVM_ARCH}"
export MY_OBJ_DIR="${HOME}/obj/${PVM_ARCH}"
export MY_LIB_DIR="${HOME}/lib/${PVM_ARCH}"
wget http://dust.ess.uci.edu/dead/makdep.c
cc -o ${MY_BIN_DIR}/makdep makdep.c
cvs -d :ext:esmf.ess.uci.edu:/u/zender/cvs co -kk c++ mie
cd ~/c++;make lib 
cd ~/mie;make mie
sudo mkdir -p /data/${USER}
export DATA="/data/${USER}"
scp -r esmf.ess.uci.edu:/ptmp/zender/aca ${DATA}

8. Run the mie executable. 

mie

Unless you have the NCO operator ncks installed, you must add the
--no_abc flag which turns off alphabetization 

mie --no_abc

Most input files are searched for in /data/zender/aca. If you do not 
have this directory, then you must explicitly specify the location
of the input data files. Yes, this is unwieldy and we hope to fix it.

mie --fl_spc_slr=/your/file/path/foo.nc

Take advantage of the flexibility of the program by specifying the 
desired size distributions and wavelength grids on the fly.
Most options are documented in the table at the end of psd.pdf:

mie --dbg=1 --aer_typ=h2o_lqd --sz_grd=log --sz_mnm=0.1 --sz_mxm=30.0 \
--sz_nbr=10 --rds_swa=7.0 --gsd_anl=1.6 --wvl_mnm=0.25 --wvl_mxm=5.0 \
--wvl_nbr=475 ${DATA}/aca/aer_h2o_lqd_07.nc

10. Wait a long time for mie to finish.
